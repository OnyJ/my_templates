# How to Rails 7 + Devise

Setting up the project :

```bash
rails new app_name
cd app_name
bundle add devise   # Adds devise to your Gemfile as follows : gem "devise", "~> 4.8"
bundle install

rails g devise:install
```

Alter code generated by Devise, to make it work with Turbo : 

```ruby
# app/controllers/turbo_devise_controller.rb

class TurboDeviseController < ApplicationController
  class Responder < ActionController::Responder
    def to_turbo_stream
      controller.render(options.merge(formats: :html))
    rescue ActionView::MissingTemplate => error
      if get?
        raise error
      elsif has_errors? && default_action
        render rendering_options.merge(formats: :html, status: :unprocessable_entity)
      else
        redirect_to navigation_location
      end
    end
  end

  self.responder = Responder
  respond_to :html, :turbo_stream
end
```
```ruby
# /config/initializers/devise.rb

# Turbo doesn't work with devise by default.
# Keep tabs on https://github.com/heartcombo/devise/issues/5446 for a possible fix
# Fix from https://gorails.com/episodes/devise-hotwire-turbo
class TurboFailureApp < Devise::FailureApp
  def respond
    if request_format == :turbo_stream
      redirect
    else
      super
    end
  end

  def skip_format?
    %w(html turbo_stream */*).include? request_format.to_s
  end
end


# ...
Devise.setup do |config|
  # ...
  
  # ==> Controller configuration
  # Configure the parent class to the devise controllers.
  config.parent_controller = 'TurboDeviseController'
  
  # ...

  # ==> Navigation configuration
  # ...
  config.navigational_formats = ['*/*', :html, :turbo_stream]

  # ...

  # ==> Warden configuration
  # ...
  config.warden do |manager|
    manager.failure_app = TurboFailureApp
  #   manager.intercept_401 = false
  #   manager.default_strategies(scope: :user).unshift :some_external_strategy
  end
  
  # ...
end
```

(Same as normal setup)  
We need to be able to send password recovery emails in development.  

```ruby
# config/environments/development.rb
# near the other action_mailer config. ~line 40 in an unaltered config file.

config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }
```

(Same as normal setup)  
Show alert and notice flash notifications

```ruby
# app/views/layouts/application.html.erb, above the <%= yield %>
<% if notice %>
  <p class="alert alert-success"><%= notice %></p>
<% end %>
<% if alert %>
  <p class="alert alert-danger"><%= alert %></p>
<% end %>
```

Generate authenticable model :

```bash
rails g devise user
```

Optionnal : edit the generated `db/migrate/<timestamp>_devise_create_users.rb` file.  
  
Database :

```bash
rake db:create
rake db:migrate
```

Routes :

```ruby
# config/routes.rbRails.application.routes.draw do
  devise_scope :user do
    # Redirests signing out users back to sign-in
    get "users", to: "devise/sessions#new"
  enddevise_for :users
end
```

Delete Method :  
Adding a log-out link with a method: :delete, won't work. Turbo hijacks the request and turns it into a GET request.  
You can specify that the link should not use turbo (`data: {turbo: false}`).  

Easier alternative :

```ruby
<%= button_to(
  "Log Out",
  destroy_user_session_path,
  method: :delete
) %>
```

From [this tutorial](https://betterprogramming.pub/devise-auth-setup-in-rails-7-44240aaed4be).

